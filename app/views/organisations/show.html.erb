<% is_admin = current_user&.organisation&.admin? %>

<h1 class="govuk-heading-l">Your organisation account</h1>

<% if is_admin %>
  <p class="govuk-body">Manage your organisational details and API keys, as well as grant access requests and manage your team members. From this page you can invite new team members to join the UK Trade Tariff Developer Portal, or remove existing members.</p>
<% else %>
  <p class="govuk-body">Manage your organisational details and request access to roles as well as invite new and remove existing members.</p>
<% end %>

<%= render 'shared/organisation_details', organisation: @organisation %>

<% unless @organisation.admin? %>
  <section class="govuk-!-margin-bottom-6">
    <h2 class="govuk-heading-m govuk-!-margin-bottom-3">Roles and permissions</h2>

    <% if @service_roles.any? %>
      <h3 class="govuk-heading-s govuk-!-margin-bottom-3">Current roles</h3>
      <%= govuk_table do |table|
        table.with_head do |head|
          head.with_row do |row|
            row.with_cell(text: 'Role')
            row.with_cell(text: 'Description')
          end
        end

        table.with_body do |body|
          @service_roles.each do |role|
            body.with_row do |row|
              row.with_cell(text: role.name)
              row.with_cell(text: role.description)
            end
          end
        end
      end %>
    <% else %>
      <p class="govuk-body">No service roles assigned.</p>
    <% end %>

    <% if @has_available_roles %>
      <div class="govuk-!-margin-top-4">
        <% if @available_without_pending.any? %>
          <%= govuk_button_link_to 'Request access', new_role_request_path %>
        <% end %>

        <% if @pending_roles.any? %>
          <div class="govuk-!-margin-top-4">
            <h3 class="govuk-heading-s">Pending requests</h3>
            <ul class="govuk-list">
              <% @pending_roles.each do |role| %>
                <li>
                  <strong><%= role.name %></strong> â€“ <%= role.description %>
                  <span class="govuk-tag govuk-tag--yellow govuk-!-margin-left-2">Request pending</span>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    <% end %>
  </section>
<% end %>

<%= govuk_table do |table| %>
  <% table.with_caption(size: 'm', text: 'Members') %>
  <% table.with_head do |head| %>
    <% head.with_row do |row| %>
      <% row.with_cell(text: 'Email address') %>
      <% row.with_cell(text: 'Created') %>
      <% row.with_cell(text: 'Actions') %>
    <% end %>
  <% end %>
  <% table.with_body do |body| %>
    <% @users.each do |user| %>
      <% body.with_row do |row| %>
        <% row.with_cell(header: true, text: user.email_address) %>
        <% row.with_cell(text: created_on(user)) %>
        <% row.with_cell do %>
          <% if user == current_user %>
            You
          <% else %>
            <%= govuk_link_to 'Remove', remove_user_path(user) %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<%= render 'shared/invitations_table', invitations: @invitations, caption: { size: 'm', text: 'Invitations' } %>

<% if @api_keys.present? %>
  <h2 class="govuk-heading-m">FPO API Keys (<%= @api_keys.count %>)</h2>
  <%= render 'shared/keys_table',
             keys: @api_keys,
             headers: { description: 'Description', identifier: 'API Key ID' },
             identifier_callable: ->(key) { key.api_key_id },
             secret_prefix: 'api-key',
             status_text_callable: ->(key) { key.enabled? ? 'Active' : 'Revoked' },
             status_colour_callable: ->(key) { key.enabled? ? :active : :revoked },
             actions_callable: ->(key) { render('shared/api_key_actions', key:) } %>
<% end %>

<% if @trade_tariff_keys.present? %>
  <h2 class="govuk-heading-m">Trade Tariff Keys (<%= @trade_tariff_keys.count %>)</h2>
  <%= render 'shared/keys_table',
             keys: @trade_tariff_keys,
             headers: { description: 'Description', identifier: 'Client ID' },
             identifier_callable: ->(key) { key.client_id },
             secret_prefix: 'trade-tariff-key',
             status_text_callable: ->(key) { key.active? ? 'Active' : 'Revoked' },
             status_colour_callable: ->(key) { key.active? ? :active : :revoked },
             actions_callable: ->(key) { render('shared/trade_tariff_key_actions', key:) } %>
<% end %>

<%= govuk_button_link_to 'Invite new member', new_invitation_path %>

<h2 class="govuk-heading-m">If you need help</h2>
<p class="govuk-body">If you have any further queries relating to the developer portal, <%= govuk_link_to 'use the enquiry form', 'https://www.trade-tariff.service.gov.uk/enquiry_form', target: '_blank' %>.</p>
