<div class="govuk-width-container">
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <p class="govuk-body">
        <%= link_to '← Back to organisations', admin_organisations_path, class: 'govuk-link' %>
      </p>
      <h1 class="govuk-heading-l"><%= @organisation.organisation_name %></h1>

      <%= render 'shared/organisation_details', organisation: @organisation %>

      <section class="govuk-!-margin-bottom-6">
        <h2 class="govuk-heading-m govuk-!-margin-bottom-3">Roles and permissions</h2>

        <% if @admin_role.present? %>
          <div class="govuk-inset-text govuk-!-margin-bottom-4">
            <p class="govuk-body">
              <strong>Admin role assigned</strong><br>
              <%= @admin_role.description %>
            </p>
          </div>
        <% end %>

        <% if @service_roles.any? %>
          <h3 class="govuk-heading-s govuk-!-margin-bottom-3">Service roles</h3>
          <%= govuk_table do |table|
            table.with_head do |head|
              head.with_row do |row|
                row.with_cell(text: 'Role')
                row.with_cell(text: 'Name')
                row.with_cell(text: 'Actions')
              end
            end

            table.with_body do |body|
              @service_roles.each do |role|
                body.with_row do |row|
                  row.with_cell(text: role.name)
                  row.with_cell(text: role.description)
                  row.with_cell do
                    button_to 'Remove', admin_organisation_roles_path(@organisation, role_name: role.name),
                              method: :delete,
                              data: { confirm: "Remove role #{role.name}?" },
                              class: 'govuk-button govuk-button--secondary govuk-!-margin-bottom-0'
                  end
                end
              end
            end
          end %>
        <% end %>

      <% unless @admin_role.present? %>
        <div class="govuk-form-group govuk-!-margin-top-4 govuk-!-margin-bottom-0">
          <h3 class="govuk-heading-s">Add a service role</h3>
          <% if @available_role_options.any? %>
            <%= form_with url: admin_organisation_roles_path(@organisation), method: :post, local: true do |form| %>
              <div class="govuk-!-margin-bottom-3">
                <label class="govuk-label" for="role_name_select">Select role</label>
                <% role_options = @available_role_options.map { |role| ["#{role.name} – #{role.description}", role.name] } %>
                <select name="role_name" id="role_name_select" class="govuk-select">
                  <% role_options.each do |label, value| %>
                    <option value="<%= value %>"><%= label %></option>
                  <% end %>
                </select>
              </div>
              <%= form.submit "Add role", class: "govuk-button" %>
            <% end %>
          <% else %>
            <p class="govuk-body">All available service roles are already assigned.</p>
          <% end %>
        </div>
      <% end %>
      </section>


      <h2 class="govuk-heading-m">Members (<%= @users.count %>)</h2>
      <%= govuk_table do |table|
        table.with_head do |head|
          head.with_row do |row|
            row.with_cell(text: 'Email address')
            row.with_cell(text: 'Created')
          end
        end
        table.with_body do |body|
          @users.each do |user|
            body.with_row do |row|
              row.with_cell(header: true, text: user.email_address)
              row.with_cell(text: user.created_at.strftime('%d %b %Y'))
            end
          end
        end
      end %>

      <h2 class="govuk-heading-m">FPO API Keys (<%= @api_keys.count %>)</h2>
      <%= render 'shared/keys_table',
                 keys: @api_keys,
                 headers: { description: 'Description', identifier: 'API Key ID' },
                 identifier_callable: ->(key) { key.api_key_id },
                 secret_prefix: 'api-key',
                 status_text_callable: ->(key) { key.enabled? ? 'Active' : 'Revoked' },
                 status_colour_callable: ->(key) { key.enabled? ? :active : :revoked },
                 actions_callable: ->(key) { render('shared/api_key_actions', key:) } %>

      <h2 class="govuk-heading-m">OTT Keys (<%= @ott_keys.count %>)</h2>
      <%= render 'shared/keys_table',
                 keys: @ott_keys,
                 headers: { description: 'Description', identifier: 'Client ID' },
                 identifier_callable: ->(key) { key.client_id },
                 secret_prefix: 'ott-key',
                 status_text_callable: ->(key) { key.active? ? 'Active' : 'Revoked' },
                 status_colour_callable: ->(key) { key.active? ? :active : :revoked },
                 actions_callable: ->(key) { render('shared/ott_key_actions', key:) } %>

      <h2 class="govuk-heading-m">Invitations (<%= @invitations.count %>)</h2>
      <%= render 'shared/invitations_table', invitations: @invitations %>
    </div>
  </div>
</div>
